# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  install_dockerise:
    machine: true
    steps:
      - checkout
      # - run:
      #     name: 'wait db'
      #     command: dockerize -wait tcp://localhost:3307 -timeout 1m
      - run:
          name: install dockerize
          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.3.0

  build:
    machine: true
    steps:
      - checkout
      - run:
          name: 'run database'
          command: cd docker-scripts && ./run-dev-database.sh
          background: true
      - run:
          name: 'seed database'
          command: cd docker-scripts && ./seed-dev-server.sh
      - run:
          name: 'run server'
          command: cd docker-scripts && ./run-dev-server.sh
          background: true

      # - restore_cache:
      #     keys:
      #       - v1-sunmait-blog-cache-{{ .Branch }}-{{ checksum "client/package-lock.json" }}
      #       - v1-sunmait-blog-cache-{{ .Branch }}-
      #       - v1-sunmait-blog-cache-
      - run:
          name: 'install client dependencies'
          command: cd client && yarn
      - run:
          name: 'install client dependencies'
          command: cd client && yarn start
          background: true
      - save_cache:
          key: v1-sunmait-blog-cache-{{ .Branch }}-{{ checksum "client/package-lock.json" }}
          paths:
              - ~/.npm
              - ~/.cache
      - run: cd client && yarn e2e-ci
  build_client:
    docker:
      - image: cypress/base:8
        environment:
            ## this enables colors in the output
            TERM: xterm
    steps:
      - checkout
      
  run_e2e:
    docker:
      - image: cypress/base:8
        environment:
            ## this enables colors in the output
            TERM: xterm

    steps:
      - checkout

      - run: cd client && yarn e2e-ci

workflows:
  version: 2
  run_server_and_test:
    jobs:
      - build